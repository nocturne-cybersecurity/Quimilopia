<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quimilopia ‚Äî Atomic Simulator v3</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="stylesheet" href="static/style.css">
<link rel="stylesheet" href="static/colors.css">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- AUTH CHECK -->
<script>
  // Verificar si el usuario est√° autenticado
  const user = sessionStorage.getItem('user');
  if (!user) {
    // Si no est√° autenticado, redirige a login
    window.location.href = 'login.html';
  }
  
  // Parsear datos del usuario
  const userData = JSON.parse(user || '{}');
  console.log('‚úì Autenticado como:', userData.name);
</script>
</head>
<body>

<div id="topbar">
  <div class="tb-logo">Quimi<span>lopia</span></div>
  <div class="tb-sep"></div>
  <div style="display:flex;gap:4px">
    <button class="tb-btn" onclick="autoReact()">
      <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M2 6C2 3.79 3.79 2 6 2s4 1.79 4 4-1.79 4-4 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M6 2V0l-1.5 2H6z" fill="currentColor"/></svg>
      Auto-Reacci√≥n
    </button>
    <button class="tb-btn bond-mode" id="bondModeBtn" onclick="toggleBondMode()">‚ö° Vincular Manual</button>
    <button class="tb-btn success" onclick="groupAsCell()">‚¨° Formar C√©lula</button>
    <button class="tb-btn" onclick="animateCells()">‚ñ∂ Animar</button>
    <button class="tb-btn" onclick="freezeCells()">‚ñ† Detener</button>
  </div>
  <div class="tb-sep"></div>
  <button class="tb-btn" onclick="clearCanvas()">üóë Limpiar</button>
  <button class="tb-btn warn" onclick="resetSim()">‚Ü∫ Reiniciar</button>
  <button class="tb-btn" onclick="takeScreenshot()" title="Descargar captura de pantalla">Captura</button>
  <button class="tb-btn" id="selModeBtn" onclick="toggleSelectionMode()" title="Shift+Click para seleccionar m√∫ltiples">Seleccionar</button>
  <div class="tb-spacer"></div>
  <div id="statusChip">Listo</div>
  <div style="width:8px"></div>
  <div style="font-size:11px;color:var(--text3);font-family:'IBM Plex Mono',monospace;">v3.4</div>
  <div class="tb-sep"></div>
  <div style="display:flex;align-items:center;gap:8px;font-size:11px;color:var(--text2);font-family:'IBM Plex Mono',monospace;">
    <span id="userNameDisplay">Usuario</span>
  </div>
  <button class="tb-btn warn" onclick="handleLogout()" title="Cerrar sesi√≥n">üö™ Salir</button>
</div>

<div id="app">

  <!-- LEFT PANEL (resizable) -->
  <div id="leftPanel" class="resizable-panel">
    <div class="resize-handle" id="leftHandle"></div>

    <!-- ATOMS -->
    <div class="panel-section">
      <div class="section-header" onclick="toggleSection('secAtoms')">
        <span>üî¨ √Åtomos</span><span class="chevron">‚ñæ</span>
      </div>
      <div id="secAtoms" class="section-body">
        <input id="atomSearch" type="text" placeholder="Buscar elemento..." oninput="filterAtoms()">
        <div id="catTabs"></div>
        <div id="atomGrid"></div>
      </div>
    </div>

    <!-- INFO -->
    <div class="panel-section">
      <div class="section-header" onclick="toggleSection('secInfo')">
        <span>‚Ñπ Info</span><span class="chevron">‚ñæ</span>
      </div>
      <div id="secInfo" class="section-body">
        <div id="infoPanel"><div class="info-empty">Haz click en un √°tomo, mol√©cula o c√©lula</div></div>
      </div>
    </div>

    <!-- RECIPES -->
    <div class="panel-section" style="flex:1;display:flex;flex-direction:column;overflow:hidden">
      <div class="section-header" onclick="toggleSection('secRecipes')">
        <span>üìã Recetas</span><span class="chevron">‚ñæ</span>
      </div>
      <div id="secRecipes" class="section-body" style="flex:1;overflow:hidden;display:flex;flex-direction:column">
        <div style="padding:6px 8px 0">
          <input id="recipeSearch" type="text" placeholder="Buscar receta..." oninput="filterRecipes()">
          <details style="margin-bottom:6px">
            <summary style="font-size:11px;color:var(--accent);cursor:pointer;padding:4px 0;font-family:'IBM Plex Mono',monospace">+ A√±adir receta personalizada</summary>
            <div id="addRecipeForm" style="margin-top:6px">
              <label>Nombre del producto (usa _ para sub√≠ndice, ^ para super√≠ndice)</label>
              <input id="nr_name" type="text" placeholder="H_2O">
              <label>Selecciona √°tomos (click para agregar):</label>
              <div id="abQuickGrid" class="atom-builder-grid"></div>
              <label style="margin-top:4px">√Åtomos seleccionados (click en √ó para quitar):</label>
              <div id="abSelectedAtoms" class="ab-selected-atoms"><span class="ab-empty">Ninguno</span></div>
              <label>Descripci√≥n</label>
              <input id="nr_desc" type="text" placeholder="Agua">
              <label>Funci√≥n biol√≥gica</label>
              <input id="nr_func" type="text" placeholder="Solvente">
              <label>Categor√≠a</label>
              <input id="nr_cat" type="text" placeholder="Inorg√°nica">
              <div class="form-row">
                <input id="nr_color" type="color" value="#64b5f6" style="width:36px;padding:2px;height:26px;border-radius:3px">
                <button class="add-recipe-btn" style="flex:1" onclick="addCustomRecipe()">‚úì Agregar Receta</button>
              </div>
            </div>
          </details>
        </div>
        <div id="recipesPanel" style="flex:1;overflow-y:auto;padding:0 8px 8px"></div>
      </div>
    </div>
  </div>

  <!-- CANVAS -->
  <div id="canvasWrap">
    <canvas id="simCanvas"></canvas>
    <canvas id="bondLine"></canvas>
    <div id="bondModeBar">‚ö° MODO VINCULACI√ìN ‚Äî Click en √°tomo A, luego √°tomo B</div>
    <div id="tooltip"></div>
    <div id="viewBar">
      <button class="vbtn active" id="lv1" onclick="setView(1)">√ÅTOMOS</button>
      <button class="vbtn" id="lv2" onclick="setView(2)">MOL√âCULAS</button>
      <button class="vbtn" id="lv3" onclick="setView(3)">C√âLULAS</button>
    </div>
    <div id="zoomLabel">100%</div>
  </div>

  <!-- RIGHT PANEL (resizable) -->
  <div id="rightPanel" class="resizable-panel">
    <div class="resize-handle" id="rightHandle"></div>

    <div class="panel-section">
      <div class="section-header" onclick="toggleSection('secMols')">
        <span>üß™ Mol√©culas <span id="molCount" style="color:var(--accent);margin-left:4px">0</span></span>
        <span class="chevron">‚ñæ</span>
      </div>
      <div id="secMols" class="section-body" style="max-height:250px;overflow-y:auto">
        <div id="moleculesList"><div class="info-empty" style="padding:6px 10px">‚Äî</div></div>
      </div>
    </div>

    <div class="panel-section" style="flex:1;overflow:hidden">
      <div class="section-header" onclick="toggleSection('secCells')">
        <span>ü´Ä C√©lulas <span id="cellCount" style="color:var(--accent4);margin-left:4px">0</span></span>
        <span class="chevron">‚ñæ</span>
      </div>
      <div id="secCells" class="section-body">
        <div id="cellsList"><div class="info-empty" style="padding:6px 10px">‚Äî</div></div>
      </div>
    </div>

    <div style="border-top:1px solid var(--border);padding:8px;overflow-y:auto;flex:1">
      <div style="font-size:10px;color:var(--text3);font-family:'IBM Plex Mono',monospace;margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px">Tipos de c√©lula</div>
      <div style="font-size:10px;font-family:'IBM Plex Mono',monospace;color:var(--text2);line-height:2.2;padding:0 2px">
        <div><span style="color:#4caf50">H‚ÇÇO+CO‚ÇÇ</span> ‚Üí Vegetal</div>
        <div><span style="color:#ef5350">NH‚ÇÉ+H‚ÇÇO</span> ‚Üí Sangu√≠nea</div>
        <div><span style="color:#42a5f5">CO‚ÇÇ+NH‚ÇÉ</span> ‚Üí Nerviosa</div>
        <div><span style="color:#ab47bc">H‚ÇÇO+C‚ÇÜH‚ÇÅ‚ÇÇO‚ÇÜ</span> ‚Üí Muscular</div>
        <div><span style="color:#ffa726">ATP+ADP</span> ‚Üí Energ√©tica</div>
        <div style="color:var(--text3)">3+ cualquiera ‚Üí Gen√©rica</div>
      </div>
    </div>
  </div>

</div>

<!-- CONTEXT MENU -->
<div id="ctxMenu">
  <div class="ctx-item" onclick="ctxDelete()">üóë Eliminar</div>
  <div class="ctx-item" onclick="ctxDuplicate()">‚ßâ Duplicar</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" onclick="ctxSelect()">‚¨° Seleccionar mol.</div>
  <div class="ctx-item" onclick="ctxDeselect()">‚úï Deseleccionar todo</div>
</div>
<script src="static/script.js"></script>
</body>
</html>
