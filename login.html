<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quimilopia — Login</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
:root {
  --bg: #1e1e1e;
  --bg2: #252526;
  --accent: #0078d4;
  --accent-h: #1a8fe0;
  --text: #cccccc;
  --text2: #9d9d9d;
  --white: #ffffff;
}
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
}

html,body{
  height:100%;
  background:var(--bg);
  color:var(--text);
  font-family:'IBM Plex Sans',sans-serif;
  display:flex;
  align-items:center;
  justify-content:center;
  animation:fadePage .8s ease;
}

/* ===== BACKGROUND ANIMADO ===== */

body::before{
  content:"";
  position:fixed;
  inset:0;
  background:
    radial-gradient(circle at 20% 30%, rgba(0,120,212,.08), transparent 40%),
    radial-gradient(circle at 80% 70%, rgba(0,120,212,.05), transparent 40%);
  animation:bgMove 12s linear infinite alternate;
  z-index:-1;
}

@keyframes bgMove{
  from{transform:translateY(-20px)}
  to{transform:translateY(20px)}
}

/* ===== PAGE FADE ===== */

@keyframes fadePage{
  from{
    opacity:0;
    transform:scale(1.02);
  }
  to{
    opacity:1;
    transform:scale(1);
  }
}

/* ===== LOGIN CARD ===== */

.login-container{
  background:var(--bg2);
  border:1px solid #404040;
  border-radius:8px;
  padding:40px;
  box-shadow:0 4px 20px rgba(0,0,0,.6);
  max-width:400px;
  width:100%;
  text-align:center;

  animation:floatIn .7s cubic-bezier(.2,.8,.2,1);
  transition:.3s;
}

.login-container:hover{
  transform:translateY(-4px);
  box-shadow:0 10px 40px rgba(0,0,0,.8);
}

@keyframes floatIn{
  from{
    opacity:0;
    transform:translateY(40px);
  }
  to{
    opacity:1;
    transform:translateY(0);
  }
}

/* ===== LOGO ===== */

.logo{
  font-family:'IBM Plex Mono',monospace;
  font-size:32px;
  font-weight:600;
  margin-bottom:10px;
  letter-spacing:1px;
}

.logo span{
  color:var(--accent);
  animation:glowPulse 2.5s infinite ease-in-out;
}

@keyframes glowPulse{
  0%,100%{
    text-shadow:0 0 5px rgba(0,120,212,.3);
  }
  50%{
    text-shadow:
      0 0 10px rgba(0,120,212,.6),
      0 0 20px rgba(0,120,212,.4);
  }
}

.subtitle{
  color:var(--text2);
  font-size:12px;
  margin-bottom:30px;
  letter-spacing:.5px;
  text-transform:uppercase;
}

.divider{
  height:1px;
  background:#404040;
  margin:20px 0;
}

/* ===== BUTTONS ===== */

#googleSignInBtn,
.email-btn,
#goToAppBtn,
#logoutBtn{
  width:100%;
  height:44px;
  border:none;
  border-radius:4px;
  cursor:pointer;
  font-weight:600;
  position:relative;
  overflow:hidden;
  transition:.25s;
}

#googleSignInBtn{
  background:white;
  color:#1f2937;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
}

.email-btn,
#goToAppBtn{
  background:var(--accent);
  color:white;
}

#logoutBtn{
  background:#555;
  color:white;
}

#googleSignInBtn::after,
.email-btn::after,
#goToAppBtn::after{
  content:"";
  position:absolute;
  width:0;
  height:100%;
  left:0;
  top:0;
  background:rgba(255,255,255,.15);
  transition:.4s;
}

#googleSignInBtn:hover::after,
.email-btn:hover::after,
#goToAppBtn:hover::after{
  width:100%;
}

#googleSignInBtn:hover,
.email-btn:hover,
#goToAppBtn:hover,
#logoutBtn:hover{
  transform:translateY(-2px);
}

.google-icon{
  width:20px;
  height:20px;
  z-index:1;
}

/* ===== INPUTS ===== */

#emailAuth input{
  width:100%;
  height:36px;
  background:var(--bg);
  border:1px solid #404040;
  border-radius:4px;
  color:var(--text);
  padding:0 10px;
  font-size:12px;
  transition:.25s;
}

#emailAuth input:focus{
  outline:none;
  border-color:var(--accent);
  box-shadow:0 0 10px rgba(0,120,212,.4);
  transform:scale(1.02);
}

/* ===== TABS ===== */

.auth-tab,
.email-subtab{
  flex:1;
  padding:8px;
  border:none;
  background:transparent;
  color:var(--text2);
  cursor:pointer;
  transition:.3s;
  font-size:14px;
}

.auth-tab.active,
.email-subtab.active{
  color:var(--accent);
  border-bottom:2px solid var(--accent);
}

/* ===== LOADING ===== */

#loading{
  display:none;
  margin:20px 0;
}

.spinner{
  border:3px solid rgba(0,120,212,.2);
  border-top-color:var(--accent);
  border-radius:50%;
  width:30px;
  height:30px;
  animation:spin 1s linear infinite;
  margin:auto;
}

@keyframes spin{
  to{transform:rotate(360deg)}
}

/* ===== SUCCESS LOGIN ===== */

.user-info{
  display:none;
  text-align:left;
  margin-top:20px;
  padding:15px;
  background:rgba(0,120,212,.1);
  border-radius:4px;
  border:1px solid rgba(0,120,212,.3);
  animation:successPop .5s ease;
}

@keyframes successPop{
  from{
    opacity:0;
    transform:scale(.8);
  }
  to{
    opacity:1;
    transform:scale(1);
  }
}

#error{
  display:none;
  color:#ef5350;
  font-size:12px;
  margin-top:10px;
  padding:10px;
  background:rgba(239,83,80,.1);
  border-radius:4px;
}

#goToAppBtn,
#logoutBtn{
  margin-top:10px;
}

#logoutBtn{
  margin-top:8px;
}
</style>
</head>
<body>
  <div class="login-container">
    <div class="logo">Quimi<span>lopia</span></div>
    <div class="subtitle">Atomic Simulator v3.4</div>
    
    <div class="divider"></div>

    <div style="margin-bottom: 20px;">
      <div style="display: flex; gap: 8px; margin-bottom: 15px; border-bottom: 1px solid #404040; padding-bottom: 10px;">
        <button id="tabGoogle" class="auth-tab active">Google</button>
        <button id="tabEmail" class="auth-tab">Email</button>
      </div>

      <!-- GOOGLE AUTH -->
      <div id="googleAuth">
        <button id="googleSignInBtn">
          <svg class="google-icon" viewBox="0 0 24 24">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          Iniciar sesión con Google
        </button>
      </div>

      <!-- EMAIL AUTH -->
      <div id="emailAuth" style="display: none;">
        <div style="display: flex; gap: 8px; margin-bottom: 15px; border-bottom: 1px solid #404040; padding-bottom: 10px;">
          <button id="btnSignIn" class="email-subtab active">Iniciar sesión</button>
          <button id="btnSignUp" class="email-subtab">Crear cuenta</button>
        </div>

        <div id="signInMode">
          <input id="emailInput" type="email" placeholder="correo@ejemplo.com" style="margin-bottom: 8px;">
          <input id="passwordInput" type="password" placeholder="Contraseña" style="margin-bottom: 8px;">
          <button id="emailSignInBtn" class="email-btn">Iniciar sesión</button>
        </div>

        <div id="signUpMode" style="display: none;">
          <input id="nameInput" type="text" placeholder="Tu nombre" style="margin-bottom: 8px;">
          <input id="emailSignUpInput" type="email" placeholder="correo@ejemplo.com" style="margin-bottom: 8px;">
          <input id="passwordSignUpInput" type="password" placeholder="Contraseña (mín. 6 caracteres)" style="margin-bottom: 8px;">
          <button id="emailSignUpBtn" class="email-btn">Crear cuenta</button>
        </div>
      </div>
    </div>

    <div id="authSection">
      <div id="loading">
        <div class="spinner"></div>
        <p style="margin-top: 10px; color: var(--text2); font-size: 12px;">Autenticando...</p>
      </div>

      <div id="error"></div>

      <div id="userInfo" class="user-info">
        <p>Bienvenido</p>
        <p><strong id="userName">Usuario</strong></p>
        <p style="font-size: 11px; color: var(--text2); margin-top: 8px;" id="userEmail">correo@ejemplo.com</p>
      </div>

      <button id="goToAppBtn" class="email-btn" style="display: none;">Ir a Quimilopia →</button>
      <button id="logoutBtn" style="display: none;">Cerrar sesión</button>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>

  <script>
    // ─── CONFIGURACIÓN DE FIREBASE ───────────────────────────────────
    // ⚠️ IMPORTANTE: Reemplaza estas credenciales con las tuyas de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDemoKey1234567890",  // REEMPLAZA
      authDomain: "your-project.firebaseapp.com",  // REEMPLAZA
      projectId: "your-project-id",  // REEMPLAZA
      storageBucket: "your-project.appspot.com",  // REEMPLAZA
      messagingSenderId: "123456789",  // REEMPLAZA
      appId: "1:123456789:web:abcdef1234567890"  // REEMPLAZA
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ─── ELEMENTOS DEL DOM ───────────────────────────────────────────
    const googleSignInBtn = document.getElementById('googleSignInBtn');
    const loading = document.getElementById('loading');
    const errorDiv = document.getElementById('error');
    const userInfo = document.getElementById('userInfo');
    const userName = document.getElementById('userName');
    const userEmail = document.getElementById('userEmail');
    const goToAppBtn = document.getElementById('goToAppBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    // Email inputs
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const nameInput = document.getElementById('nameInput');
    const emailSignUpInput = document.getElementById('emailSignUpInput');
    const passwordSignUpInput = document.getElementById('passwordSignUpInput');
    const emailSignInBtn = document.getElementById('emailSignInBtn');
    const emailSignUpBtn = document.getElementById('emailSignUpBtn');

    // Tabs
    const tabGoogle = document.getElementById('tabGoogle');
    const tabEmail = document.getElementById('tabEmail');
    const googleAuth = document.getElementById('googleAuth');
    const emailAuth = document.getElementById('emailAuth');
    const btnSignIn = document.getElementById('btnSignIn');
    const btnSignUp = document.getElementById('btnSignUp');
    const signInMode = document.getElementById('signInMode');
    const signUpMode = document.getElementById('signUpMode');

    // ─── FUNCIONES ──────────────────────────────────────────────────
    function switchAuthTab(tab) {
      if (tab === 'google') {
        googleAuth.style.display = 'block';
        emailAuth.style.display = 'none';
        tabGoogle.classList.add('active');
        tabEmail.classList.remove('active');
      } else {
        googleAuth.style.display = 'none';
        emailAuth.style.display = 'block';
        tabGoogle.classList.remove('active');
        tabEmail.classList.add('active');
        emailInput.focus();
      }
    }

    function switchEmailMode(mode) {
      if (mode === 'signin') {
        signInMode.style.display = 'block';
        signUpMode.style.display = 'none';
        btnSignIn.classList.add('active');
        btnSignUp.classList.remove('active');
        emailInput.focus();
      } else {
        signInMode.style.display = 'none';
        signUpMode.style.display = 'block';
        btnSignIn.classList.remove('active');
        btnSignUp.classList.add('active');
        nameInput.focus();
      }
    }

    function showError(message) {
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 5000);
    }

    function saveUserToFirestore(user) {
      db.collection('users').doc(user.uid).set({
        uid: user.uid,
        name: user.displayName || 'Usuario',
        email: user.email,
        photo: user.photoURL || null,
        lastAccess: new Date()
      }, { merge: true }).catch(error => {
        console.error('Error guardando en Firestore:', error);
      });
    }

    function saveUserToSession(user) {
      sessionStorage.setItem('user', JSON.stringify({
        uid: user.uid,
        name: user.displayName || 'Usuario',
        email: user.email,
        photo: user.photoURL || null
      }));
    }

    function showAuthSuccess(user) {
      userName.textContent = user.displayName || user.email.split('@')[0];
      userEmail.textContent = user.email;
      
      loading.style.display = 'none';
      document.getElementById('googleAuth').style.display = 'none';
      document.getElementById('emailAuth').style.display = 'none';
      userInfo.style.display = 'block';
      goToAppBtn.style.display = 'block';
      logoutBtn.style.display = 'block';
    }

    function handleGoogleSignIn() {
      loading.style.display = 'block';
      errorDiv.style.display = 'none';
      const provider = new firebase.auth.GoogleAuthProvider();
      
      auth.signInWithPopup(provider)
        .then(result => {
          const user = result.user;
          saveUserToFirestore(user);
          saveUserToSession(user);
          showAuthSuccess(user);
        })
        .catch(error => {
          loading.style.display = 'none';
          showError('Error con Google: ' + error.message);
        });
    }

    function handleEmailSignIn() {
      const email = emailInput.value.trim();
      const password = passwordInput.value;

      if (!email || !password) {
        showError('Por favor completa todos los campos');
        return;
      }

      loading.style.display = 'block';
      errorDiv.style.display = 'none';
      emailSignInBtn.disabled = true;

      auth.signInWithEmailAndPassword(email, password)
        .then(result => {
          const user = result.user;
          saveUserToFirestore(user);
          saveUserToSession(user);
          showAuthSuccess(user);
        })
        .catch(error => {
          loading.style.display = 'none';
          emailSignInBtn.disabled = false;
          
          if (error.code === 'auth/user-not-found') {
            showError('Usuario no encontrado');
          } else if (error.code === 'auth/wrong-password') {
            showError('Contraseña incorrecta');
          } else if (error.code === 'auth/invalid-email') {
            showError('Email inválido');
          } else {
            showError('Error: ' + error.message);
          }
        });
    }

    function handleEmailSignUp() {
      const name = nameInput.value.trim();
      const email = emailSignUpInput.value.trim();
      const password = passwordSignUpInput.value;

      if (!name || !email || !password) {
        showError('Por favor completa todos los campos');
        return;
      }

      if (password.length < 6) {
        showError('La contraseña debe tener al menos 6 caracteres');
        return;
      }

      loading.style.display = 'block';
      errorDiv.style.display = 'none';
      emailSignUpBtn.disabled = true;

      auth.createUserWithEmailAndPassword(email, password)
        .then(result => {
          const user = result.user;
          return user.updateProfile({ displayName: name }).then(() => user);
        })
        .then(user => {
          saveUserToFirestore(user);
          saveUserToSession(user);
          showAuthSuccess(user);
        })
        .catch(error => {
          loading.style.display = 'none';
          emailSignUpBtn.disabled = false;

          if (error.code === 'auth/email-already-in-use') {
            showError('Este email ya está registrado');
          } else if (error.code === 'auth/invalid-email') {
            showError('Email inválido');
          } else if (error.code === 'auth/weak-password') {
            showError('Contraseña muy débil');
          } else {
            showError('Error: ' + error.message);
          }
        });
    }

    function handleLogout() {
      auth.signOut().then(() => {
        sessionStorage.removeItem('user');
        googleAuth.style.display = 'block';
        emailAuth.style.display = 'none';
        userInfo.style.display = 'none';
        goToAppBtn.style.display = 'none';
        logoutBtn.style.display = 'none';
        emailInput.value = '';
        passwordInput.value = '';
        nameInput.value = '';
        emailSignUpInput.value = '';
        passwordSignUpInput.value = '';
        
        // Reset tabs
        switchAuthTab('google');
        switchEmailMode('signin');
      });
    }

    // ─── EVENT LISTENERS ───────────────────────────────────────────
    tabGoogle.addEventListener('click', () => switchAuthTab('google'));
    tabEmail.addEventListener('click', () => switchAuthTab('email'));
    btnSignIn.addEventListener('click', () => switchEmailMode('signin'));
    btnSignUp.addEventListener('click', () => switchEmailMode('signup'));
    
    googleSignInBtn.addEventListener('click', handleGoogleSignIn);
    emailSignInBtn.addEventListener('click', handleEmailSignIn);
    emailSignUpBtn.addEventListener('click', handleEmailSignUp);
    goToAppBtn.addEventListener('click', () => {
      window.location.href = 'index.html';
    });
    logoutBtn.addEventListener('click', handleLogout);

    // Permitir Enter en los campos de email
    emailInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleEmailSignIn();
    });
    passwordInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleEmailSignIn();
    });
    nameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleEmailSignUp();
    });
    emailSignUpInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleEmailSignUp();
    });
    passwordSignUpInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleEmailSignUp();
    });

    // ─── VERIFICAR SI YA ESTÁ LOGUEADO ─────────────────────────────
    auth.onAuthStateChanged(user => {
      if (user) {
        // Usuario ya está logueado
        userName.textContent = user.displayName || user.email.split('@')[0];
        userEmail.textContent = user.email;
        googleAuth.style.display = 'none';
        emailAuth.style.display = 'none';
        loading.style.display = 'none';
        userInfo.style.display = 'block';
        goToAppBtn.style.display = 'block';
        logoutBtn.style.display = 'block';

        sessionStorage.setItem('user', JSON.stringify({
          uid: user.uid,
          name: user.displayName,
          email: user.email,
          photo: user.photoURL
        }));
      } else {
        // Usuario no está logueado
        googleAuth.style.display = 'block';
        emailAuth.style.display = 'none';
        loading.style.display = 'none';
        userInfo.style.display = 'none';
        goToAppBtn.style.display = 'none';
        logoutBtn.style.display = 'none';
      }
    });

    // Inicializar tabs
    switchAuthTab('google');
    switchEmailMode('signin');
  </script>
</body>
</html>
